<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Caddie Roulette</title>
    
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FFFFFF">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #064E3B; 
            --primary-light: #059669; 
            --accent: #FACC15; 
            --text-main: #1F2937;
            --font-display: "Impact", "Arial Black", sans-serif;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #FFFFFF; /* NO MORE GREEN BACKGROUND */
            color: var(--text-main); 
            font-family: var(--font-sans); 
            height: 100dvh; 
            overflow: hidden; 
            display: flex;
            align-items: flex-start; /* Aligns to top to prevent vertical centering issues */
            justify-content: center;
        }
        
        /* APP CONTAINER - FULL BLEED */
        .app-container { 
            width: 100%;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            background: #FFFFFF; 
            position: relative;
        }
        
        /* On Desktop, we still limit width but keep background white to blend in */
        @media (min-width: 500px) {
            body { background: #f0f0f0; align-items: center; } /* Light grey on desktop to distinguish phone area */
            .app-container {
                max-width: 450px;
                height: 90vh;
                border-radius: 24px;
                box-shadow: 0 0 50px rgba(0,0,0,0.1);
                overflow: hidden;
            }
        }

        /* HEADER */
        .header { 
            background: #FFFFFF; 
            height: 60px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-bottom: 1px solid #F3F4F6;
            flex-shrink: 0;
            position: relative;
            z-index: 20;
        }
        .header-logo { height: 40px; width: 40px; }
        .header-right { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
        .header-left { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); }
        .room-code { font-family: var(--font-display); font-size: 24px; color: #1F2937; }
        .header-btn { background: transparent; border: none; cursor: pointer; color: #6B7280; display: flex; align-items: center; justify-content: center; padding: 8px; }

        /* MAIN CONTENT - SPLIT SCREEN */
        .game-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100%;
            overflow: hidden;
        }

        /* TOP SECTION: WHEEL (Flexible but dominates space) */
        .top-section {
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: #F9FAFB; /* Subtle contrast */
            width: 100%;
            position: relative;
        }

        /* BOTTOM SECTION: CONTROLS (RIGID FIXED HEIGHT) */
        .bottom-section {
            height: 40%; /* FIXED PERCENTAGE - NEVER CHANGES */
            min-height: 280px;
            max-height: 400px;
            background: #FFFFFF;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            border-top: 1px solid #E5E7EB;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
            z-index: 10;
        }

        /* BUTTONS */
        .btn { 
            border: none; padding: 20px 0; border-radius: 12px; 
            font-weight: 800; font-size: 18px; width: 100%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            text-transform: uppercase; letter-spacing: 1px;
            margin-top: auto; /* Pushes to bottom of container if needed */
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: #422006; }
        
        /* WHEEL */
        .wheel-stage {
            position: relative; width: 260px; height: 260px; border-radius: 50%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            background: #111827; 
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .wheel-rim { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 12px solid #281D11; pointer-events: none; z-index: 20; }
        .wheel-spinner {
            width: 94%; height: 94%; border-radius: 50%; position: relative;
            background: conic-gradient(
                #DC2626 0deg 30deg, #1F2937 30deg 60deg, #DC2626 60deg 90deg, #1F2937 90deg 120deg, 
                #DC2626 120deg 150deg, #1F2937 150deg 180deg, #DC2626 180deg 210deg, #1F2937 210deg 240deg, 
                #DC2626 240deg 270deg, #1F2937 270deg 300deg, #DC2626 300deg 330deg, #1F2937 330deg 360deg
            );
            transition: transform 3s cubic-bezier(0.2, 0.8, 0.1, 1); 
        }
        .wheel-center {
            position: absolute; width: 90px; height: 90px; background: #111827; border: 4px solid #FACC15;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 30; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .result-number { font-size: 32px; font-weight: 900; color: white; line-height: 1; }
        .result-label { font-size: 8px; color: #FACC15; font-weight: 700; letter-spacing: 1px; margin-top: 4px; }
        
        .ball { position: absolute; top: 18px; left: 50%; margin-left: -5px; width: 10px; height: 10px; background: white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        .ball-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 25; }

        /* ZONE SELECTOR */
        .zone-selector { display: flex; gap: 8px; margin-bottom: 24px; background: #E5E7EB; padding: 6px; border-radius: 12px; width: 100%; }
        .zone-btn { flex: 1; padding: 10px 0; border-radius: 8px; border: none; background: transparent; color: #6B7280; font-weight: 700; font-size: 11px; cursor: pointer; }
        .zone-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* RESULT DISPLAY */
        .result-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .result-badge { 
            width: 70px; height: 70px; background: #DC2626; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-display); font-size: 32px; color: white;
            border: 4px solid #1F2937; margin-bottom: 24px; flex-shrink: 0;
        }
        .result-text { 
            font-family: var(--font-display); font-size: 28px; color: #1F2937; 
            text-transform: uppercase; text-align: center; line-height: 1.1; margin-bottom: 24px;
            flex: 1; display: flex; align-items: center;
        }

        /* INPUTS */
        .input-lg { font-size: 20px; padding: 16px; text-align: center; border: 2px solid #E5E7EB; border-radius: 12px; width: 100%; outline: none; font-weight: 700; text-transform: uppercase; background: #F9FAFB; margin-bottom: 16px; }
        .input-lg:focus { border-color: var(--primary); background: white; }

        /* MODAL */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 24px; border-radius: 24px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; max-height: 85vh; }
        
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #E5E7EB; text-align: left; }
        .toggle-switch { width: 44px; height: 24px; background: #E5E7EB; border-radius: 20px; position: relative; cursor: pointer; transition: 0.2s; }
        .toggle-switch.on { background: var(--primary-light); }
        .toggle-circle { width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toggle-switch.on .toggle-circle { left: 22px; }

        .challenge-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #F3F4F6; text-align: left; font-size: 13px; color: #374151; }
        .challenge-num { width: 24px; height: 24px; background: #111827; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; margin-right: 12px; flex-shrink: 0; }
        .challenge-num.red { background: #DC2626; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc, signInAnonymously, signOut, onAuthStateChanged, getAuth } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"; 
        /* NOTE: The import above was mixed up in previous standard boilerplate. 
           Fixing imports to separate files properly for Module script 
        */
    </script>
    <script type="module">
        // RE-IMPORTING CORRECTLY FOR MODULE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCw3_nIjjDYUo-lVpV7qtj6Kdn9dbPM0dE",
          authDomain: "caddieroulette-9f6b4.firebaseapp.com",
          projectId: "caddieroulette-9f6b4",
          storageBucket: "caddieroulette-9f6b4.firebasestorage.app",
          messagingSenderId: "108668982333",
          appId: "1:108668982333:web:0f5eabea5caec6ab844654"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.ops = { collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc, signInAnonymously, signOut, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CHALLENGES = {
            TEE: [
                "Driver off the Deck", "7-Iron Only", "Eyes Closed Swing", 
                "Happy Gilmore", "Wrong Handed", "Yell 'MASHED POTATOES'",
                "Tee it High (Driver)", "No Practice Swing", "Must Hit Fade",
                "Must Hit Draw", "Silence (No Talking)", "Commentate Your Shot"
            ],
            APPROACH: [
                "Club Up 2 (Half Swing)", "Putter from Fairway", "Baseball Grip",
                "One Handed Finish", "Low Stinger", "Stand on One Leg",
                "Opponent Picks Club", "Aim Way Left (Slice Back)", "Aim Way Right (Hook Back)",
                "Eyes Closed Impact", "3-Second Swing", "Yell 'FORE' at Impact"
            ],
            GREEN: [
                "Putt with Wedge", "Pool Cue Style", "Eyes Closed Putt",
                "Opponent Places Ball", "Pin In", "Chip on Green",
                "Lag Putt Only", "One Handed Putt", "No Read Allowed",
                "Knee Putt", "Reverse Grip", "Eyes Open (Normal)"
            ]
        };

        // --- SUB-COMPONENTS ---
        const Modal = ({ isOpen, title, message, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h3 style={{fontSize: 20, fontWeight: 800, marginBottom: 8, color: '#1F2937'}}>{title}</h3>
                        <p style={{color: '#4B5563', marginBottom: 20}}>{message}</p>
                        <button className="btn btn-primary" onClick={onClose}>GOT IT</button>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, soundOn, toggleSound, onLogout }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:20}}>
                            <h2 style={{fontFamily:'var(--font-display)', fontSize:24, color:'#1F2937'}}>SETTINGS</h2>
                            <button onClick={onClose} style={{border:'none', background:'transparent'}}><i data-lucide="x" color="#9CA3AF"></i></button>
                        </div>
                        <div className="settings-row">
                             <span style={{fontWeight:600, color:'#374151'}}>Sound Effects</span>
                             <div className={`toggle-switch ${soundOn ? 'on' : ''}`} onClick={toggleSound}>
                                 <div className="toggle-circle"></div>
                             </div>
                        </div>
                        <div style={{marginTop:20, paddingTop:20, borderTop:'1px solid #E5E7EB'}}>
                            <button className="btn btn-danger" onClick={onLogout}>EXIT GAME</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RouletteWheel = ({ isSpinning, resultNumber, zone }) => {
            return (
                <div className="wheel-stage">
                    <div className="wheel-rim"></div>
                    <div className="wheel-spinner" style={{
                        transform: !isSpinning && resultNumber ? `rotate(-${(resultNumber - 1) * 30 + 15}deg)` : (isSpinning ? '' : 'rotate(0deg)'),
                        animation: isSpinning ? 'spinCW 0.6s linear infinite' : 'none'
                    }}>
                        {[...Array(12)].map((_, i) => (
                            <div key={i} className="wheel-number" style={{
                                transform: `rotate(${i * 30 + 15}deg) translate(0, -100px)`
                            }}>{i + 1}</div>
                        ))}
                    </div>
                    <div className="ball-container" style={{ animation: isSpinning ? 'spinCCW 1.5s linear infinite' : 'none' }}>
                        <div className="ball"></div>
                    </div>
                    <div className="wheel-center">
                        {isSpinning ? (
                                <div style={{fontSize:10, color:'#FACC15', fontWeight:800}}>SPINNING</div>
                        ) : (
                            <>
                                <div className="result-label">{zone}</div>
                                <div className="result-number">{resultNumber || "?"}</div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [gameCode, setGameCode] = useState("");
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [zone, setZone] = useState("TEE");
            const [currentNumber, setCurrentNumber] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [modal, setModal] = useState({ open: false, title: "", message: "" });
            const [showSettings, setShowSettings] = useState(false);
            const [soundOn, setSoundOn] = useState(true);
            const spinSound = useRef(new Audio("https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3"));

            useEffect(() => {
                if(!window.ops) return;
                const unsub = window.ops.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!gameCode || !window.ops) return;
                let interval;
                const unsub = window.ops.onSnapshot(window.ops.doc(window.db, "games", gameCode), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setGameData(data);
                        if (data.isSpinning) {
                            setIsSpinning(true);
                            if(!interval && soundOn) {
                                interval = setInterval(() => {
                                    spinSound.current.currentTime = 0;
                                    spinSound.current.volume = 0.1;
                                    spinSound.current.play().catch(e=>{});
                                }, 100);
                            }
                        } else {
                            setIsSpinning(false);
                            if(interval) clearInterval(interval);
                            if(data.lastNumber) setCurrentNumber(data.lastNumber);
                        }
                    }
                });
                return () => { unsub(); if(interval) clearInterval(interval); };
            }, [gameCode, soundOn]);

            useEffect(() => { if(window.lucide) window.lucide.createIcons(); });

            const handleLogout = async () => { setShowSettings(false); await window.ops.signOut(window.auth); setGameCode(""); setGameData(null); };
            const handleLogin = async () => { await window.ops.signInAnonymously(window.auth); };
            
            const createGame = async () => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                await window.ops.setDoc(window.ops.doc(window.db, "games", code), {
                    host: user.uid, lastNumber: null, isSpinning: false, zone: "TEE", createdAt: new Date()
                });
                setGameCode(code);
            };
            
            const joinGame = async (codeInput) => {
                const code = codeInput.toUpperCase();
                if(code.length !== 4) return;
                const ref = window.ops.doc(window.db, "games", code);
                const snap = await window.ops.getDoc(ref);
                if (snap.exists()) setGameCode(code);
                else setModal({ open: true, title: "Error", message: "Room not found." });
            };
            
            const handleSpin = async () => {
                if(isSpinning) return;
                const ref = window.ops.doc(window.db, "games", gameCode);
                await window.ops.updateDoc(ref, { isSpinning: true, zone: zone, lastNumber: null });
                setTimeout(async () => {
                    const result = Math.floor(Math.random() * 12) + 1;
                    await window.ops.updateDoc(ref, { isSpinning: false, lastNumber: result });
                }, 3000); 
            };

            const Header = () => (
                <div className="header">
                    {gameCode && (
                        <div className="header-left">
                            <div className="room-code">{gameCode}</div>
                        </div>
                    )}
                    <img src="./images/logo512.png" className="header-logo" />
                    <div className="header-right">
                        <button className="header-btn" onClick={() => setShowSettings(true)}>
                            <i data-lucide="settings"></i>
                        </button>
                    </div>
                </div>
            );

            if (loading) return <div className="app-container" style={{justifyContent:'center', alignItems:'center'}}>Loading...</div>;

            // --- 1. LANDING PAGE ---
            if (!user) return (
                <div className="app-container">
                    <div className="game-content">
                        <div className="top-section" style={{flexDirection:'column', background:'white'}}>
                            <img src="./images/logo512.png" style={{width:100, height:100, marginBottom:20}} />
                            <h1 style={{fontFamily:'var(--font-display)', fontSize:40, lineHeight:1, marginBottom:16, color:'var(--primary)'}}>CADDIE ROULETTE</h1>
                            <h3 style={{fontSize:18, fontWeight:700, color:'#1F2937'}}>Your 15th Club.</h3>
                        </div>
                        <div className="bottom-section">
                            <p style={{marginBottom:30, color:'#6B7280', fontSize:14, lineHeight:1.5, textAlign:'center'}}>
                                Add unpredictable challenges to your round.
                            </p>
                            <button className="btn btn-primary" onClick={handleLogin}>START PLAYING</button>
                        </div>
                    </div>
                </div>
            );

            // --- 2. CREATE/JOIN PAGE ---
            if (!gameCode) return (
                <div className="app-container">
                    <Modal isOpen={modal.open} title={modal.title} message={modal.message} onClose={() => setModal({...modal, open: false})} />
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} soundOn={soundOn} toggleSound={() => setSoundOn(!soundOn)} onLogout={handleLogout} />
                    
                    <Header />
                    <div className="game-content">
                        <div className="top-section" style={{background:'white', flexDirection:'column'}}>
                            <h2 style={{fontSize:24, fontWeight:800, color:'#374151', marginBottom:20}}>NEW ROUND?</h2>
                            <button className="btn btn-primary" onClick={createGame} style={{width:'80%', maxWidth:'300px'}}>CREATE ROOM</button>
                        </div>
                        <div className="bottom-section">
                            <p style={{fontSize:12, fontWeight:700, color:'#9CA3AF', marginBottom:16}}>OR JOIN FRIEND</p>
                            <input id="codeInput" className="input-lg" placeholder="CODE" maxLength="4" />
                            <button className="btn btn-accent" onClick={() => joinGame(document.getElementById('codeInput').value)}>
                                JOIN
                            </button>
                        </div>
                    </div>
                </div>
            );

            // --- 3. GAME PAGE ---
            return (
                <div className="app-container">
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} soundOn={soundOn} toggleSound={() => setSoundOn(!soundOn)} onLogout={handleLogout} />
                    
                    <Header />
                    <div className="game-content">
                        <div className="top-section">
                             <RouletteWheel isSpinning={isSpinning} resultNumber={currentNumber} zone={gameData?.zone || 'TEE'} />
                        </div>
                        
                        <div className="bottom-section">
                            {!isSpinning && currentNumber ? (
                                <div className="result-container">
                                        <div className="result-badge">{currentNumber}</div>
                                        <div className="result-text">{CHALLENGES[gameData.zone][currentNumber - 1]}</div>
                                        <button className="btn btn-primary" onClick={() => setCurrentNumber(null)}>OK</button>
                                </div>
                            ) : (
                                (gameData && gameData.host === user.uid) ? (
                                    <>
                                        <div className="zone-selector">
                                            {['TEE', 'APPROACH', 'GREEN'].map(z => (
                                                <button key={z} className={`zone-btn ${zone === z ? 'active' : ''}`} onClick={() => setZone(z)}>{z}</button>
                                            ))}
                                        </div>
                                        <button className="btn btn-accent" onClick={handleSpin} disabled={isSpinning} style={{opacity: isSpinning ? 0.6 : 1}}>
                                            {isSpinning ? 'SPINNING...' : 'SPIN THE WHEEL'}
                                        </button>
                                    </>
                                ) : (
                                    <div style={{textAlign:'center', color:'#374151', fontWeight:800}}>
                                        {isSpinning ? 'HOST IS SPINNING...' : 'WAITING FOR HOST'}
                                    </div>
                                )
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>