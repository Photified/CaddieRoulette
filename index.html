<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Caddie Roulette</title>
    
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#064E3B">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #064E3B; --primary-light: #059669; --accent: #FACC15; 
            --bg-body: #064E3B;
            --glass: #FFFFFF;
            --text-main: #1F2937;
            --font-display: "Impact", "Arial Black", sans-serif;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-body);
            background-image: radial-gradient(circle at center, #065f46 0%, #022c22 100%);
            color: var(--text-main); 
            font-family: var(--font-sans); 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* LAYOUT */
        .app-container { 
            width: 100%;
            max-width: 450px; 
            height: 100%;
            max-height: 850px; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            background: transparent;
        }
        @media (min-width: 500px) {
            .app-container {
                border-radius: 24px;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
                height: 90vh;
                overflow: hidden;
                background: rgba(0,0,0,0.2); 
            }
        }

        /* HEADER */
        .header { 
            background: #FFFFFF; 
            height: 90px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 20; 
            position: relative;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            flex-shrink: 0;
            padding: 0 20px;
        }
        
        .header-logo { 
            height: 70px; width: 70px; 
            transition: transform 0.2s;
        }
        
        .header-left {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .room-label { font-size: 9px; font-weight: 800; color: #9CA3AF; letter-spacing: 1px; text-transform: uppercase; }
        .room-code { font-family: var(--font-display); font-size: 28px; color: #1F2937; line-height: 1; letter-spacing: 1px; }

        .header-right { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
        .header-btn { 
            background: #F3F4F6; border: none; color: var(--primary); 
            padding: 10px; border-radius: 12px; width: 44px; height: 44px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: background 0.2s;
        }
        .header-btn:active { background: #E5E7EB; transform: scale(0.95); }

        /* CONTENT */
        .game-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            scrollbar-width: none; 
            position: relative;
        }
        .game-content::-webkit-scrollbar { display: none; }
        
        .card { 
            background: var(--glass); 
            padding: 16px; 
            border-radius: 24px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            margin-bottom: 20px; 
            animation: slideUp 0.3s ease-out;
            position: relative; 
            overflow: hidden;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* BUTTONS */
        .btn { 
            border: none; padding: 16px; border-radius: 14px; 
            font-weight: 800; font-size: 16px; width: 100%; cursor: pointer; 
            transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; 
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(to bottom, #10B981, #059669); color: white; box-shadow: 0 6px 0 #064E3B; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .btn-primary:active { box-shadow: 0 0 0 #064E3B; transform: translateY(6px); }
        .btn-accent { background: linear-gradient(to bottom, #FACC15, #EAB308); color: #422006; box-shadow: 0 6px 0 #854D0E; }
        .btn-accent:active { box-shadow: 0 0 0 #854D0E; transform: translateY(6px); }
        .btn-danger { background: #fee2e2; color: #dc2626; font-weight: 700; box-shadow: none; }
        .btn-outline { background: white; border: 2px solid #E5E7EB; color: #374151; box-shadow: 0 4px 0 #E5E7EB; }
        
        /* WHEEL STYLES - FIXED RIM */
        .wheel-container-wrapper {
            position: relative; display: flex; justify-content: center; margin-bottom: 20px; min-height: 300px;
        }
        .wheel-stage {
            position: relative; width: 300px; height: 300px; border-radius: 50%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            background: #111827; /* Dark background behind wheel */
            overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        
        /* THICKER RIM TO HIDE GLITCHES */
        .wheel-rim {
            position: absolute; width: 260px; height: 260px; border-radius: 50%;
            border: 16px solid #1F2937; /* Much thicker, dark rim */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8); 
            z-index: 5; pointer-events: none;
        }
        
        .wheel-spinner {
            width: 290px; height: 290px; border-radius: 50%; position: relative;
            transition: transform 3s cubic-bezier(0.2, 0.8, 0.1, 1); 
            background: conic-gradient(
                #DC2626 0deg 30deg, #1F2937 30deg 60deg, 
                #DC2626 60deg 90deg, #1F2937 90deg 120deg, 
                #DC2626 120deg 150deg, #1F2937 150deg 180deg, 
                #DC2626 180deg 210deg, #1F2937 210deg 240deg, 
                #DC2626 240deg 270deg, #1F2937 270deg 300deg, 
                #DC2626 300deg 330deg, #1F2937 330deg 360deg
            );
            transform: rotate(0deg);
        }
        .wheel-spinner.spinning { animation: spinCW 0.6s linear infinite; }
        @keyframes spinCW { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .wheel-number {
            position: absolute; top: 50%; left: 50%;
            font-family: var(--font-display); color: white; font-size: 18px; width: 20px; height: 20px; line-height: 20px; text-align: center;
            margin-top: -10px; margin-left: -10px; text-shadow: 0 1px 2px black;
        }

        .ball-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }
        .ball-container.spinning { animation: spinCCW 1.5s linear infinite; }
        @keyframes spinCCW { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
        .ball {
            position: absolute; top: 20px; left: 50%; margin-left: -6px; width: 12px; height: 12px;
            background: #FFFFFF; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.8);
        }
        .ball-container.spinning .ball { animation: bounce 0.3s ease-in-out infinite alternate; }
        @keyframes bounce { from { top: 20px; } to { top: 15px; } }

        .wheel-center {
            position: absolute; width: 120px; height: 120px; background: #111827; border: 4px solid #FACC15;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .result-number { font-size: 42px; font-weight: 900; color: white; line-height: 1; }
        .result-label { font-size: 10px; color: #FACC15; font-weight: 700; letter-spacing: 1px; margin-top: 4px; }

        /* --- REDESIGNED POPUP --- */
        .controls-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFFFFF;
            z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
            
            /* Clean Card Style */
            border: 4px solid #1F2937;
            border-radius: 20px;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* BADGE INSIDE CARD */
        .result-badge {
            background: #DC2626; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-display); font-size: 32px;
            border: 4px solid #1F2937;
            margin-bottom: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .result-text { 
            color: #1F2937; font-family: var(--font-display); 
            font-size: 28px; 
            line-height: 1.1; margin-bottom: 24px; 
            text-transform: uppercase; padding: 0 10px;
        }

        /* CONTROLS */
        .zone-selector { display: flex; gap: 8px; margin-bottom: 12px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 16px; }
        .zone-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: transparent; color: rgba(255,255,255,0.6); font-weight: 700; font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .zone-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* INPUTS */
        .input-lg { font-size: 24px; padding: 16px; text-align: center; border: 2px solid #E5E7EB; border-radius: 12px; width: 100%; outline: none; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; background: #F9FAFB; }
        .input-lg:focus { border-color: var(--primary); background: white; }
        
        /* MODAL */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 90; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 24px; border-radius: 24px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; max-height: 85vh; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* SETTINGS PAGE */
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #E5E7EB; text-align: left; }
        .settings-label { font-weight: 600; font-size: 16px; color: #374151; }
        .toggle-switch { width: 50px; height: 28px; background: #E5E7EB; border-radius: 20px; position: relative; cursor: pointer; transition: 0.2s; }
        .toggle-switch.on { background: var(--primary-light); }
        .toggle-circle { width: 24px; height: 24px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch.on .toggle-circle { left: 24px; }
        
        /* HOW TO GRID */
        .howto-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .howto-item { background: #F9FAFB; padding: 16px 10px; border-radius: 16px; text-align: center; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }
        .howto-icon-box { background: #DCFCE7; color: #166534; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .howto-text { font-size: 12px; font-weight: 700; color: #4B5563; line-height: 1.3; }
        .section-title { font-size: 12px; font-weight: 800; color: #9CA3AF; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; text-align: left; }

        /* CHALLENGE LIST VIEW */
        .challenge-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 700; background: #F3F4F6; border: none; border-radius: 8px; cursor: pointer; color: #6B7280; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .challenge-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #F3F4F6; text-align: left; font-size: 13px; color: #374151; }
        .challenge-num { width: 24px; height: 24px; background: #111827; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; margin-right: 12px; flex-shrink: 0; }
        .challenge-num.red { background: #DC2626; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCw3_nIjjDYUo-lVpV7qtj6Kdn9dbPM0dE",
          authDomain: "caddieroulette-9f6b4.firebaseapp.com",
          projectId: "caddieroulette-9f6b4",
          storageBucket: "caddieroulette-9f6b4.firebasestorage.app",
          messagingSenderId: "108668982333",
          appId: "1:108668982333:web:0f5eabea5caec6ab844654"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.provider = new GoogleAuthProvider();
        window.ops = { collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc, arrayUnion, increment, signInWithPopup, signOut, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GAME DATA (12 Slots) ---
        const CHALLENGES = {
            TEE: [
                "Driver off the Deck", "7-Iron Only", "Eyes Closed Swing", 
                "Happy Gilmore", "Wrong Handed", "Yell 'MASHED POTATOES'",
                "Tee it High (Driver)", "No Practice Swing", "Must Hit Fade",
                "Must Hit Draw", "Silence (No Talking)", "Commentate Your Shot"
            ],
            APPROACH: [
                "Club Up 2 (Half Swing)", "Putter from Fairway", "Baseball Grip",
                "One Handed Finish", "Low Stinger", "Stand on One Leg",
                "Opponent Picks Club", "Aim Way Left (Slice Back)", "Aim Way Right (Hook Back)",
                "Eyes Closed Impact", "3-Second Swing", "Yell 'FORE' at Impact"
            ],
            GREEN: [
                "Putt with Wedge", "Pool Cue Style", "Eyes Closed Putt",
                "Opponent Places Ball", "Pin In", "Chip on Green",
                "Lag Putt Only", "One Handed Putt", "No Read Allowed",
                "Knee Putt", "Reverse Grip", "Eyes Open (Normal)"
            ]
        };

        // --- COMPONENTS ---
        const Modal = ({ isOpen, title, message, onClose, type = 'neutral' }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{height:'auto'}}>
                        <div style={{fontSize: 40, marginBottom: 10}}>
                            {type === 'error' ? '‚ö†Ô∏è' : (type === 'success' ? 'üéâ' : '‚ÑπÔ∏è')}
                        </div>
                        <h3 style={{fontSize: 20, fontWeight: 800, marginBottom: 8, color: '#1F2937'}}>{title}</h3>
                        <p style={{color: '#4B5563', marginBottom: 20}}>{message}</p>
                        <button className="btn btn-primary" onClick={onClose}>GOT IT</button>
                    </div>
                </div>
            );
        };

        const ChallengesModal = ({ isOpen, onClose }) => {
            const [activeTab, setActiveTab] = useState('TEE');
            if (!isOpen) return null;
            return (
                 <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                         <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10, borderBottom:'1px solid #E5E7EB', paddingBottom:10}}>
                            <h2 style={{fontFamily:'var(--font-display)', fontSize:24, color:'#1F2937'}}>CHALLENGES</h2>
                            <button onClick={onClose} style={{border:'none', background:'transparent'}}><i data-lucide="x" color="#9CA3AF"></i></button>
                        </div>
                        <div className="challenge-tabs">
                            {['TEE', 'APPROACH', 'GREEN'].map(t => (
                                <button key={t} className={`tab-btn ${activeTab === t ? 'active' : ''}`} onClick={() => setActiveTab(t)}>{t}</button>
                            ))}
                        </div>
                        <div style={{flex: 1, overflowY:'auto', border:'1px solid #E5E7EB', borderRadius:12, padding:'0 12px'}}>
                            {CHALLENGES[activeTab].map((c, i) => (
                                <div key={i} className="challenge-item">
                                    <div className={`challenge-num ${(i+1)%2 !== 0 ? 'red' : ''}`}>{i+1}</div>
                                    {c}
                                </div>
                            ))}
                        </div>
                    </div>
                 </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, soundOn, toggleSound, installEvent, onInstall, onLogout, onOpenChallenges }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10, borderBottom:'1px solid #E5E7EB', paddingBottom:10}}>
                            <h2 style={{fontFamily:'var(--font-display)', fontSize:24, color:'#1F2937'}}>SETTINGS</h2>
                            <button onClick={onClose} style={{border:'none', background:'transparent'}}><i data-lucide="x" color="#9CA3AF"></i></button>
                        </div>
                        
                        <div style={{flex:1, overflowY:'auto'}}>
                            <div className="section-title">HOW IT WORKS</div>
                            <div className="howto-grid">
                                <div className="howto-item"><div className="howto-icon-box"><i data-lucide="users"></i></div><div className="howto-text">Host creates a room</div></div>
                                <div className="howto-item"><div className="howto-icon-box"><i data-lucide="share"></i></div><div className="howto-text">Share the 4-letter code</div></div>
                                <div className="howto-item"><div className="howto-icon-box"><i data-lucide="target"></i></div><div className="howto-text">Host picks the zone</div></div>
                                <div className="howto-item"><div className="howto-icon-box"><i data-lucide="trophy"></i></div><div className="howto-text">Spin & win points</div></div>
                            </div>

                             <div className="settings-row">
                                <span className="settings-label">Sound Effects</span>
                                <div className={`toggle-switch ${soundOn ? 'on' : ''}`} onClick={toggleSound}>
                                    <div className="toggle-circle"></div>
                                </div>
                            </div>
                            
                            <div style={{padding:'10px 0'}}>
                                <button className="btn btn-outline" onClick={onOpenChallenges}>
                                    <i data-lucide="list"></i> VIEW CHALLENGES
                                </button>
                            </div>

                            {installEvent && (
                                <div style={{padding:'10px 0'}}>
                                    <button className="btn btn-primary" onClick={onInstall}>
                                        <i data-lucide="download"></i> INSTALL APP
                                    </button>
                                </div>
                            )}
                        </div>

                        <div style={{marginTop:20, paddingTop:20, borderTop:'1px solid #E5E7EB'}}>
                            <button className="btn btn-danger" onClick={onLogout}>
                                <i data-lucide="log-out"></i> LOG OUT
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const RouletteWheel = ({ isSpinning, resultNumber, zone, onClearResult }) => {
            // Rotation Logic: 12 segments (30deg). Center is 15deg. 
            // Rotation = -( (Num-1)*30 + 15 )
            
            return (
                <div className="wheel-container-wrapper">
                    <div className="wheel-stage">
                        <div className="wheel-rim"></div>
                        
                        <div className={`wheel-spinner ${isSpinning ? 'spinning' : ''}`} style={{
                            transform: !isSpinning && resultNumber ? `rotate(-${(resultNumber - 1) * 30 + 15}deg)` : 'rotate(0deg)'
                        }}>
                            {[...Array(12)].map((_, i) => (
                                <div key={i} className="wheel-number" style={{
                                    transform: `rotate(${i * 30 + 15}deg) translate(0, -120px)`
                                }}>
                                    {i + 1}
                                </div>
                            ))}
                        </div>
                        
                        <div className={`ball-container ${isSpinning ? 'spinning' : ''}`} style={{
                             transform: !isSpinning ? 'rotate(0deg)' : ''
                        }}>
                            <div className="ball"></div>
                        </div>

                        <div className="wheel-center">
                            {isSpinning ? (
                                 <div style={{fontSize:12, color:'#FACC15', fontWeight:800}}>SPINNING</div>
                            ) : (
                                <>
                                    <div className="result-label">{zone}</div>
                                    <div className="result-number">{resultNumber || "?"}</div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PlayerList = ({ players, onScore }) => (
            <div className="card" style={{padding:0, overflow:'hidden', border:'none', marginTop:'auto'}}>
                <div style={{background:'#F3F4F6', padding:'12px 16px', fontSize:11, fontWeight:800, color:'#6B7280', letterSpacing:1}}>LEADERBOARD</div>
                {players.sort((a,b) => b.score - a.score).map((p, i) => (
                    <div key={i} style={{display:'flex', alignItems:'center', padding:'16px', borderBottom:'1px solid #F3F4F6', background: i===0 ? '#FEF9C3' : 'white'}}>
                        <img src={p.photo} style={{width:40, height:40, borderRadius:'50%', marginRight:12, border: i===0 ? '2px solid #FACC15' : '2px solid transparent'}} />
                        <div style={{flex:1, fontWeight:600, color: '#1F2937'}}>
                            {p.name}
                            {i === 0 && <span style={{fontSize:14, marginLeft:6}}>üëë</span>}
                        </div>
                        <div style={{fontSize:20, fontWeight:800, marginRight:16, color: i===0 ? '#B45309' : '#374151'}}>{p.score}</div>
                        <button onClick={() => onScore(p.uid)} style={{width:36, height:36, borderRadius:10, border:'none', background:'#D1FAE5', color:'#065F46', display:'flex', alignItems:'center', justifyContent:'center', cursor:'pointer', boxShadow:'0 2px 0 #6EE7B7'}}>
                            <i data-lucide="plus" size="18"></i>
                        </button>
                    </div>
                ))}
            </div>
        );

        // GLOBAL HELPER
        window.getChallengeText = (num, z) => {
             return CHALLENGES[z][num - 1] || "Unknown";
        };

        function App() {
            const [user, setUser] = useState(null);
            const [gameCode, setGameCode] = useState("");
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [zone, setZone] = useState("TEE");
            const [currentNumber, setCurrentNumber] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [modal, setModal] = useState({ open: false, title: "", message: "", type: "neutral" });
            const [showSettings, setShowSettings] = useState(false);
            const [showChallenges, setShowChallenges] = useState(false); 
            const [soundOn, setSoundOn] = useState(true);
            const [installPrompt, setInstallPrompt] = useState(null);
            const spinSound = useRef(new Audio("https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3"));

            useEffect(() => {
                const unsub = window.ops.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!gameCode) return;
                let interval;
                const unsub = window.ops.onSnapshot(window.ops.doc(window.db, "games", gameCode), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setGameData(data);
                        if (data.isSpinning) {
                            setIsSpinning(true);
                            if(!interval && soundOn) {
                                interval = setInterval(() => {
                                    spinSound.current.currentTime = 0;
                                    spinSound.current.volume = 0.1;
                                    spinSound.current.play().catch(e=>{});
                                }, 100);
                            }
                        } else {
                            setIsSpinning(false);
                            if(interval) clearInterval(interval);
                            if(data.lastNumber) setCurrentNumber(data.lastNumber);
                        }
                    }
                });
                return () => { unsub(); if(interval) clearInterval(interval); };
            }, [gameCode, soundOn]);

            useEffect(() => { lucide.createIcons(); }, [user, gameData, loading, showSettings, showChallenges]);

            const handleInstall = () => { if(installPrompt) installPrompt.prompt(); };
            const handleLogout = async () => { setShowSettings(false); await window.ops.signOut(window.auth); setGameCode(""); setGameData(null); };
            const handleLogin = async () => { await window.ops.signInWithPopup(window.auth, window.provider); };
            const createGame = async () => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                await window.ops.setDoc(window.ops.doc(window.db, "games", code), {
                    host: user.uid,
                    players: [{ uid: user.uid, name: user.displayName.split(" ")[0], photo: user.photoURL, score: 0 }],
                    lastNumber: null, isSpinning: false, zone: "TEE", createdAt: new Date()
                });
                setGameCode(code);
            };
            const joinGame = async (codeInput) => {
                const code = codeInput.toUpperCase();
                if(code.length !== 4) { setModal({ open: true, title: "Invalid Code", message: "Enter the 4-letter code.", type: "error" }); return; }
                const ref = window.ops.doc(window.db, "games", code);
                const snap = await window.ops.getDoc(ref);
                if (snap.exists()) {
                    const players = snap.data().players || [];
                    if (!players.find(p => p.uid === user.uid)) {
                        await window.ops.updateDoc(ref, { players: window.ops.arrayUnion({ uid: user.uid, name: user.displayName.split(" ")[0], photo: user.photoURL, score: 0 }) });
                    }
                    setGameCode(code);
                } else {
                    setModal({ open: true, title: "Game Not Found", message: "That room doesn't exist.", type: "error" });
                }
            };
            const handleSpin = async () => {
                if(isSpinning) return;
                const ref = window.ops.doc(window.db, "games", gameCode);
                try {
                    await window.ops.updateDoc(ref, { isSpinning: true, zone: zone, lastNumber: null }); // Clear previous
                    setTimeout(async () => {
                        const result = Math.floor(Math.random() * 12) + 1;
                        await window.ops.updateDoc(ref, { isSpinning: false, lastNumber: result });
                    }, 3000); 
                } catch (error) { await window.ops.updateDoc(ref, { isSpinning: false }); }
            };
            const handleClearResult = async () => {
                 setCurrentNumber(null);
            };
            const addPoint = async (uid) => {
                const ref = window.ops.doc(window.db, "games", gameCode);
                const snap = await window.ops.getDoc(ref);
                const newPlayers = snap.data().players.map(p => { if (p.uid === uid) return { ...p, score: p.score + 1 }; return p; });
                await window.ops.updateDoc(ref, { players: newPlayers });
            };

            if (loading) return <div className="app-container" style={{justifyContent:'center', alignItems:'center', color:'white'}}>Loading...</div>;

            if (!user) return (
                <div className="app-container" style={{justifyContent:'center'}}>
                     <div className="card" style={{textAlign:'center', margin:'20px'}}>
                        <img src="./images/logo512.png" className="header-logo" style={{width:100, height:100, margin:'0 auto 20px'}} />
                        <h1 style={{fontFamily:'var(--font-display)', fontSize:32, lineHeight:1, marginBottom:10, color:'var(--primary)'}}>CADDIE ROULETTE</h1>
                        <p style={{marginBottom:30, color:'#6B7280'}}>The ultimate golf party game.</p>
                        <button className="btn btn-primary" onClick={handleLogin}>
                            <i data-lucide="log-in"></i> Sign in with Google
                        </button>
                    </div>
                </div>
            );

            const Header = () => (
                <div className="header">
                    {gameCode && (
                        <div className="header-left">
                            <div className="room-label">ROOM</div>
                            <div className="room-code">{gameCode}</div>
                        </div>
                    )}
                    <img src="./images/logo512.png" className="header-logo" />
                    <div className="header-right">
                        <button className="header-btn" onClick={() => setShowSettings(true)}>
                            <i data-lucide="settings" size="24"></i>
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="app-container">
                    <Modal isOpen={modal.open} title={modal.title} message={modal.message} type={modal.type} onClose={() => setModal({...modal, open: false})} />
                    
                    <SettingsModal 
                        isOpen={showSettings} 
                        onClose={() => setShowSettings(false)} 
                        soundOn={soundOn} 
                        toggleSound={() => setSoundOn(!soundOn)} 
                        installEvent={installPrompt} 
                        onInstall={handleInstall} 
                        onLogout={handleLogout}
                        onOpenChallenges={() => setShowChallenges(true)}
                    />
                    
                    <ChallengesModal isOpen={showChallenges} onClose={() => setShowChallenges(false)} />

                    <Header />

                    {!gameCode ? (
                        <div className="game-content" style={{justifyContent:'center'}}>
                             <div className="card" style={{textAlign:'center'}}>
                                <div style={{display:'flex', alignItems:'center', justifyContent:'center', gap:10, marginBottom:20}}>
                                    <img src={user.photoURL} style={{width:40, height:40, borderRadius:'50%'}}/>
                                    <h3 style={{fontSize:18}}>Hi, {user.displayName.split(" ")[0]}</h3>
                                </div>
                                <button className="btn btn-primary" onClick={createGame} style={{marginBottom:16}}>Start New Game</button>
                                <div style={{margin:'24px 0', display:'flex', alignItems:'center', color:'#9CA3AF', fontSize:12, fontWeight:700}}>
                                    <span style={{flex:1, height:1, background:'#E5E7EB'}}></span>
                                    <span style={{padding:'0 10px'}}>OR JOIN FRIEND</span>
                                    <span style={{flex:1, height:1, background:'#E5E7EB'}}></span>
                                </div>
                                <div style={{display:'flex', gap:8}}>
                                    <input id="codeInput" className="input-lg" placeholder="CODE" maxLength="4" />
                                    <button className="btn btn-accent" style={{width:'auto', padding:'0 24px'}} onClick={() => joinGame(document.getElementById('codeInput').value)}>
                                        <i data-lucide="arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="game-content">
                            <RouletteWheel 
                                isSpinning={isSpinning} 
                                resultNumber={currentNumber} 
                                zone={gameData?.zone || 'TEE'} 
                                onClearResult={handleClearResult}
                            />
                            
                            <div className="card">
                                {(gameData && gameData.host === user.uid) ? (
                                    <>
                                        <div className="zone-selector">
                                            {['TEE', 'APPROACH', 'GREEN'].map(z => (
                                                <button key={z} className={`zone-btn ${zone === z ? 'active' : ''}`} onClick={() => setZone(z)}>{z}</button>
                                            ))}
                                        </div>
                                        <button className="btn btn-accent" onClick={handleSpin} disabled={isSpinning} style={{fontSize:20, padding:20, opacity: isSpinning ? 0.6 : 1}}>
                                            {isSpinning ? 'SPINNING...' : 'SPIN THE WHEEL'}
                                        </button>
                                    </>
                                ) : (
                                    <div style={{textAlign:'center', color:'#374151', fontWeight:800}}>
                                        {isSpinning ? 'HOST IS SPINNING...' : 'WAITING FOR HOST'}
                                    </div>
                                )}

                                {/* REDESIGNED RESULT POPUP */}
                                {!isSpinning && currentNumber && (
                                    <div className="controls-overlay">
                                         <div className="result-badge">{currentNumber}</div>
                                         <div className="result-text">{window.getChallengeText(currentNumber, zone)}</div>
                                         <button className="btn btn-primary" onClick={handleClearResult} style={{marginTop:'auto', padding: '12px 30px'}}>OK</button>
                                    </div>
                                )}
                            </div>

                            <PlayerList players={gameData?.players || []} onScore={addPoint} />
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>