<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Caddie Roulette</title>
    
    <link rel="manifest" href="./manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FFFFFF">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #064E3B; 
            --primary-light: #059669; 
            --accent: #FACC15; 
            --text-main: #1F2937;
            --font-display: "Impact", "Arial Black", sans-serif;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #FFFFFF; 
            color: var(--text-main); 
            font-family: var(--font-sans); 
            height: 100dvh; 
            overflow: hidden; 
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        /* APP CONTAINER - INVISIBLE BOUNDARIES */
        .app-container { 
            width: 100%;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            background: #FFFFFF; 
            position: relative;
            box-shadow: none !important;
            border: none !important;
        }

        /* Desktop Constraint: Only constrains width, DOES NOT ADD VISUAL BOX */
        @media (min-width: 500px) {
            .app-container {
                max-width: 450px; 
                margin: 0 auto;
            }
        }

        /* HEADER */
        .header { 
            height: 60px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0;
            position: relative;
            z-index: 20;
            width: 100%;
            background: #FFFFFF;
        }
        .header-logo { height: 40px; width: 40px; }
        .header-right { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
        .header-btn { background: transparent; border: none; cursor: pointer; color: #9CA3AF; padding: 8px; }
        .room-code { position: absolute; left: 20px; font-family: var(--font-display); font-size: 20px; color: #9CA3AF; letter-spacing: 1px; }

        /* MAIN LAYOUT */
        .game-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100%;
            overflow: hidden;
        }

        /* TOP SECTION: WHEEL */
        .top-section {
            height: 55%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 100%;
            position: relative;
            overflow: visible; 
        }

        /* BOTTOM SECTION: CONTROLS */
        .bottom-section {
            height: 45%; 
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            padding: 0 30px; 
            background: #FFFFFF;
        }

        /* COMPONENTS */
        .btn { 
            border: none; padding: 22px 0; border-radius: 16px; 
            font-weight: 800; font-size: 18px; width: 100%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            text-transform: uppercase; letter-spacing: 2px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: #422006; }
        
        /* WHEEL */
        .wheel-stage {
            position: relative; width: 280px; height: 280px; border-radius: 50%;
            background: #111827; 
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            box-shadow: none; 
            border: 4px solid #111827; 
        }
        .wheel-rim { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 12px solid #281D11; pointer-events: none; z-index: 20; }
        .wheel-spinner {
            width: 94%; height: 94%; border-radius: 50%; position: relative;
            background: conic-gradient(
                #DC2626 0deg 30deg, #1F2937 30deg 60deg, #DC2626 60deg 90deg, #1F2937 90deg 120deg, 
                #DC2626 120deg 150deg, #1F2937 150deg 180deg, #DC2626 180deg 210deg, #1F2937 210deg 240deg, 
                #DC2626 240deg 270deg, #1F2937 270deg 300deg, #DC2626 300deg 330deg, #1F2937 330deg 360deg
            );
            transition: transform 3s cubic-bezier(0.2, 0.8, 0.1, 1); 
        }
        
        /* RESTORED: Wheel Numbers */
        .wheel-number {
            position: absolute; top: 50%; left: 50%;
            font-family: var(--font-display); color: white; font-size: 16px; 
            width: 20px; height: 20px; line-height: 20px; text-align: center;
            margin-top: -10px; margin-left: -10px; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .wheel-center {
            position: absolute; width: 100px; height: 100px; background: #111827; border: 4px solid #FACC15;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 30;
        }
        .result-number-center { font-size: 38px; font-weight: 900; color: white; line-height: 1; }
        .result-label-center { font-size: 10px; color: #FACC15; font-weight: 700; letter-spacing: 1px; margin-top: 4px; }
        
        /* RESTORED: Ball Visibility */
        .ball { 
            position: absolute; top: 18px; left: 50%; margin-left: -6px; width: 12px; height: 12px; 
            background: white; border-radius: 50%; 
            box-shadow: 0 0 4px rgba(0,0,0,0.8); 
            z-index: 35;
        }
        .ball-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 25; }

        /* ZONE SELECTOR */
        .zone-selector { display: flex; gap: 0; margin-bottom: 30px; background: #F3F4F6; padding: 4px; border-radius: 14px; width: 100%; }
        .zone-btn { flex: 1; padding: 14px 0; border-radius: 12px; border: none; background: transparent; color: #9CA3AF; font-weight: 800; font-size: 11px; cursor: pointer; letter-spacing: 1px; }
        .zone-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* RESULT DISPLAY */
        .result-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: popIn 0.2s; }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .result-text { 
            font-family: var(--font-display); font-size: 42px; color: #1F2937; 
            text-transform: uppercase; text-align: center; line-height: 1; margin-bottom: 40px;
            width: 100%;
        }
        .result-badge-big {
            width: 60px; height: 60px; background: #DC2626; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 24px;
            border: 4px solid #1F2937; margin-bottom: 20px;
        }

        .input-lg { font-size: 24px; padding: 20px; text-align: center; border: 2px solid #E5E7EB; border-radius: 16px; width: 100%; outline: none; font-weight: 800; letter-spacing: 4px; text-transform: uppercase; background: #F9FAFB; margin-bottom: 20px; }
        .input-lg:focus { border-color: var(--primary); background: white; }

        /* MODAL */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; text-align: center; display: flex; flex-direction: column; }
        
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #F3F4F6; text-align: left; width: 100%; }
        .toggle-switch { width: 50px; height: 30px; background: #E5E7EB; border-radius: 30px; position: relative; cursor: pointer; transition: 0.2s; }
        .toggle-switch.on { background: var(--primary); }
        .toggle-circle { width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .toggle-switch.on .toggle-circle { left: 22px; }

        .challenge-item { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid #F3F4F6; text-align: left; font-size: 14px; color: #374151; font-weight: 600; }
        .challenge-num { width: 28px; height: 28px; background: #111827; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; margin-right: 14px; flex-shrink: 0; }
        .challenge-num.red { background: #DC2626; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCw3_nIjjDYUo-lVpV7qtj6Kdn9dbPM0dE",
          authDomain: "caddieroulette-9f6b4.firebaseapp.com",
          projectId: "caddieroulette-9f6b4",
          storageBucket: "caddieroulette-9f6b4.firebasestorage.app",
          messagingSenderId: "108668982333",
          appId: "1:108668982333:web:0f5eabea5caec6ab844654"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.ops = { collection, addDoc, doc, updateDoc, onSnapshot, getDoc, setDoc, signInAnonymously, signOut, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CHALLENGES = {
            TEE: [
                "Driver off the Deck", "7-Iron Only", "Eyes Closed Swing", 
                "Happy Gilmore", "Wrong Handed", "Yell 'MASHED POTATOES'",
                "Tee it High (Driver)", "No Practice Swing", "Must Hit Fade",
                "Must Hit Draw", "Silence (No Talking)", "Commentate Your Shot"
            ],
            APPROACH: [
                "Club Up 2 (Half Swing)", "Putter from Fairway", "Baseball Grip",
                "One Handed Finish", "Low Stinger", "Stand on One Leg",
                "Opponent Picks Club", "Aim Way Left (Slice Back)", "Aim Way Right (Hook Back)",
                "Eyes Closed Impact", "3-Second Swing", "Yell 'FORE' at Impact"
            ],
            GREEN: [
                "Putt with Wedge", "Pool Cue Style", "Eyes Closed Putt",
                "Opponent Places Ball", "Pin In", "Chip on Green",
                "Lag Putt Only", "One Handed Putt", "No Read Allowed",
                "Knee Putt", "Reverse Grip", "Eyes Open (Normal)"
            ]
        };

        const Modal = ({ isOpen, title, message, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h3 style={{fontSize: 24, fontWeight: 900, marginBottom: 10, color: '#1F2937', textTransform:'uppercase'}}>{title}</h3>
                        <p style={{color: '#4B5563', marginBottom: 30, fontSize:16, lineHeight:1.5}}>{message}</p>
                        <button className="btn btn-primary" onClick={onClose}>GOT IT</button>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, soundOn, toggleSound, onLogout }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:30}}>
                            <h2 style={{fontFamily:'var(--font-display)', fontSize:32, color:'#1F2937'}}>SETTINGS</h2>
                            <button onClick={onClose} style={{border:'none', background:'transparent'}}><i data-lucide="x" color="#9CA3AF" size="28"></i></button>
                        </div>
                        <div className="settings-row">
                             <span style={{fontWeight:700, fontSize:18, color:'#374151'}}>Sound Effects</span>
                             <div className={`toggle-switch ${soundOn ? 'on' : ''}`} onClick={toggleSound}>
                                 <div className="toggle-circle"></div>
                             </div>
                        </div>
                        <div style={{marginTop:40}}>
                            <button className="btn btn-primary" style={{background:'#FEE2E2', color:'#DC2626', boxShadow:'none'}} onClick={onLogout}>EXIT GAME</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RouletteWheel = ({ isSpinning, resultNumber, zone }) => {
            return (
                <div className="wheel-stage">
                    <div className="wheel-rim"></div>
                    <div className="wheel-spinner" style={{
                        transform: !isSpinning && resultNumber ? `rotate(-${(resultNumber - 1) * 30 + 15}deg)` : (isSpinning ? '' : 'rotate(0deg)'),
                        animation: isSpinning ? 'spinCW 0.6s linear infinite' : 'none'
                    }}>
                        {[...Array(12)].map((_, i) => (
                            <div key={i} className="wheel-number" style={{
                                transform: `rotate(${i * 30 + 15}deg) translate(0, -100px)`
                            }}>{i + 1}</div>
                        ))}
                    </div>
                    <div className="ball-container" style={{ animation: isSpinning ? 'spinCCW 1.5s linear infinite' : 'none' }}>
                        <div className="ball"></div>
                    </div>
                    <div className="wheel-center">
                        {isSpinning ? (
                                <div style={{fontSize:10, color:'#FACC15', fontWeight:800}}>SPINNING</div>
                        ) : (
                            <>
                                <div className="result-label-center">{zone}</div>
                                <div className="result-number-center">{resultNumber || "?"}</div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [gameCode, setGameCode] = useState("");
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [zone, setZone] = useState("TEE");
            const [currentNumber, setCurrentNumber] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [modal, setModal] = useState({ open: false, title: "", message: "" });
            const [showSettings, setShowSettings] = useState(false);
            const [soundOn, setSoundOn] = useState(true);
            const spinSound = useRef(new Audio("https://cdn.freesound.org/previews/256/256113_3263906-lq.mp3"));

            useEffect(() => {
                const unsub = window.ops.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!gameCode) return;
                let interval;
                const unsub = window.ops.onSnapshot(window.ops.doc(window.db, "games", gameCode), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setGameData(data);
                        if (data.isSpinning) {
                            setIsSpinning(true);
                            if(!interval && soundOn) {
                                interval = setInterval(() => {
                                    spinSound.current.currentTime = 0;
                                    spinSound.current.volume = 0.1;
                                    spinSound.current.play().catch(e=>{});
                                }, 100);
                            }
                        } else {
                            setIsSpinning(false);
                            if(interval) clearInterval(interval);
                            if(data.lastNumber) setCurrentNumber(data.lastNumber);
                        }
                    }
                });
                return () => { unsub(); if(interval) clearInterval(interval); };
            }, [gameCode, soundOn]);

            useEffect(() => { if(window.lucide) window.lucide.createIcons(); });

            const handleLogout = async () => { setShowSettings(false); await window.ops.signOut(window.auth); setGameCode(""); setGameData(null); };
            const handleLogin = async () => { await window.ops.signInAnonymously(window.auth); };
            
            const createGame = async () => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                await window.ops.setDoc(window.ops.doc(window.db, "games", code), {
                    host: user.uid, lastNumber: null, isSpinning: false, zone: "TEE", createdAt: new Date()
                });
                setGameCode(code);
            };
            
            const joinGame = async (codeInput) => {
                const code = codeInput.toUpperCase();
                if(code.length !== 4) return;
                const ref = window.ops.doc(window.db, "games", code);
                const snap = await window.ops.getDoc(ref);
                if (snap.exists()) setGameCode(code);
                else setModal({ open: true, title: "Error", message: "Room not found." });
            };
            
            const handleSpin = async () => {
                if(isSpinning) return;
                const ref = window.ops.doc(window.db, "games", gameCode);
                await window.ops.updateDoc(ref, { isSpinning: true, zone: zone, lastNumber: null });
                setTimeout(async () => {
                    const result = Math.floor(Math.random() * 12) + 1;
                    await window.ops.updateDoc(ref, { isSpinning: false, lastNumber: result });
                }, 3000); 
            };

            const Header = () => (
                <div className="header">
                    {gameCode && <div className="room-code">{gameCode}</div>}
                    <img src="./images/logo512.png" className="header-logo" />
                    <div className="header-right">
                        <button className="header-btn" onClick={() => setShowSettings(true)}>
                            <i data-lucide="settings" size="24"></i>
                        </button>
                    </div>
                </div>
            );

            if (loading) return <div className="app-container" style={{justifyContent:'center', alignItems:'center'}}>Loading...</div>;

            // --- 1. START PAGE ---
            if (!user) return (
                <div className="app-container">
                    <div className="game-content">
                        <div className="top-section" style={{flexDirection:'column'}}>
                            <img src="./images/logo512.png" style={{width:120, height:120, marginBottom:30}} />
                            <h1 style={{fontFamily:'var(--font-display)', fontSize:48, lineHeight:1, marginBottom:10, color:'var(--primary)', textAlign:'center'}}>CADDIE<br/>ROULETTE</h1>
                        </div>
                        <div className="bottom-section">
                             <h3 style={{fontSize:16, fontWeight:700, color:'#374151', textTransform:'uppercase', letterSpacing:1, marginBottom:10}}>Your 15th Club</h3>
                            <p style={{marginBottom:40, color:'#6B7280', fontSize:14, lineHeight:1.6, textAlign:'center', maxWidth:300}}>
                                Spin for random challenges on the tee, fairway, and green. It won't help your score, but it will change the game.
                            </p>
                            <button className="btn btn-primary" onClick={handleLogin}>START ROUND</button>
                        </div>
                    </div>
                </div>
            );

            // --- 2. JOIN PAGE ---
            if (!gameCode) return (
                <div className="app-container">
                    <Modal isOpen={modal.open} title={modal.title} message={modal.message} onClose={() => setModal({...modal, open: false})} />
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} soundOn={soundOn} toggleSound={() => setSoundOn(!soundOn)} onLogout={handleLogout} />
                    
                    <Header />
                    <div className="game-content">
                        <div className="top-section" style={{flexDirection:'column'}}>
                            <h2 style={{fontFamily:'var(--font-display)', fontSize:32, color:'#374151', marginBottom:30}}>NEW ROUND?</h2>
                            <button className="btn btn-primary" onClick={createGame} style={{width:'80%', maxWidth:'300px'}}>CREATE ROOM</button>
                        </div>
                        <div className="bottom-section">
                            <p style={{fontSize:12, fontWeight:800, color:'#9CA3AF', marginBottom:20, letterSpacing:1}}>OR JOIN FRIEND</p>
                            <input id="codeInput" className="input-lg" placeholder="ENTER CODE" maxLength="4" />
                            <button className="btn btn-accent" onClick={() => joinGame(document.getElementById('codeInput').value)}>
                                JOIN ROOM
                            </button>
                        </div>
                    </div>
                </div>
            );

            // --- 3. GAME PAGE ---
            return (
                <div className="app-container">
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} soundOn={soundOn} toggleSound={() => setSoundOn(!soundOn)} onLogout={handleLogout} />
                    
                    <Header />
                    <div className="game-content">
                        <div className="top-section">
                             <RouletteWheel isSpinning={isSpinning} resultNumber={currentNumber} zone={gameData?.zone || 'TEE'} />
                        </div>
                        
                        <div className="bottom-section">
                            {!isSpinning && currentNumber ? (
                                <div className="result-container">
                                        <div className="result-badge-big">{currentNumber}</div>
                                        <div className="result-text">{CHALLENGES[gameData.zone][currentNumber - 1]}</div>
                                        <button className="btn btn-primary" onClick={() => setCurrentNumber(null)}>OK</button>
                                </div>
                            ) : (
                                (gameData && gameData.host === user.uid) ? (
                                    <>
                                        <div className="zone-selector">
                                            {['TEE', 'APPROACH', 'GREEN'].map(z => (
                                                <button key={z} className={`zone-btn ${zone === z ? 'active' : ''}`} onClick={() => setZone(z)}>{z}</button>
                                            ))}
                                        </div>
                                        <button className="btn btn-accent" onClick={handleSpin} disabled={isSpinning} style={{opacity: isSpinning ? 0.6 : 1}}>
                                            {isSpinning ? 'SPINNING...' : 'SPIN THE WHEEL'}
                                        </button>
                                    </>
                                ) : (
                                    <div style={{textAlign:'center', color:'#9CA3AF', fontWeight:800, letterSpacing:1}}>
                                        {isSpinning ? 'HOST IS SPINNING...' : 'WAITING FOR HOST'}
                                    </div>
                                )
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>